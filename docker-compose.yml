# ⚠️ WARNING: This docker-compose file is mainly intended for development.
# For production deployments, please use the example docker-compose files
# provided in doc/deploy/ (examples available for SQLite, MariaDB and PostgreSQL).
---
services:

  exelearning:
    build: .
    container_name: exelearning
    hostname: exelearning # Important! To be called from chrome container
    env_file:
      - .env.dist
      - .env # Overrides what is defined in .env
    ports:
      - ${APP_PORT}:8080 # Maps the host's $APP_PORT to the container's port 8080
      # - 9003:9003 # Port for Xdebug, you don't need to map this port, because is the container who connects to the host xdebug
    restart: unless-stopped # Restart the container unless it is stopped manually
    volumes:
      ##FORDELETEINCI-START
      # Source code - CACHED (you edit on Windows, container reads)
      - ./src:/app/src:cached
      - ./tests:/app/tests:cached
      - ./templates:/app/templates:cached
      - ./translations:/app/translations:cached
      - ./public:/app/public:cached
      ##FORDELETEINCI-END

      # Config - CACHED (mainly read-only)
      - ./config:/app/config:cached

      # Composer files - no modifier (require consistency)
      - ./composer.json:/app/composer.json
      - ./composer.lock:/app/composer.lock

      # Anonym volumes - MUCH faster
      - /app/vendor          # ← Not synchronized with host
      - /app/var             # ← Cache and logs
      - /app/node_modules    # ← To avoid copying npm files

      # Persistent data
      - mnt-data:/mnt/data:rw

      # Screenshots - DELEGATED (container writes)
      - ./e2e_screenshots:/tmp/e2e_screenshots:delegated
    tmpfs:
      - /app/public/bundles:rw,size=64m,mode=1777 # public/bundles mounted as tmpfs to avoid permission errors
    environment:
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_JWT_SECRET_KEY}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_JWT_SECRET_KEY}
      # Force OPcache to check for updated script (for developent)
      opcache_validate_timestamps: 1
      PRE_CONFIGURE_COMMANDS:
      POST_CONFIGURE_COMMANDS: |
        echo "this is a test line 1"
        echo "this is a test line 2"
        php bin/console app:create-user ${TEST_USER_EMAIL} ${TEST_USER_PASSWORD} ${TEST_USER_USERNAME} --no-fail

  #  ⚠️ WARNING: Uncomment this for using mariadb as local database for development 
  #     # Database settings
  #     DB_DRIVER: pdo_mysql
  #     DB_HOST: mariadb
  #     DB_PORT: 3306
  #     DB_NAME: "${DB_NAME:-exelearning}"
  #     DB_USER: "${DB_USER:-exelearning}"
  #     DB_PASSWORD: "${DB_PASSWORD:-exelearning}"
  #     DB_CHARSET: "${DB_CHARSET:-utf8mb4}"
  #     DB_SERVER_VERSION: 10.6
  #   depends_on:
  #     - mariadb
  # mariadb:
  #   image: mariadb:12.0
  #   restart: unless-stopped
  #   environment:
  #     MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD:-root}"
  #     MARIADB_DATABASE: "${DB_NAME:-exelearning}"
  #     MARIADB_USER: "${DB_USER:-exelearning}"
  #     MARIADB_PASSWORD: "${DB_PASSWORD:-exelearning}"


  # Watches SCSS changes and compiles main.scss to main.css using sass
  scss-watcher:
    image: node:25-alpine
    container_name: scss-watcher
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - CHOKIDAR_USEPOLLING=1
      - CHOKIDAR_INTERVAL=500
    command: sh -lc "npm i --no-fund sass && npx sass --watch assets/styles/main.scss:public/style/workarea/main.css --style=expanded --embed-source-map"
    profiles: ["dev"]

  # The alpine-chromium image includes a browser configured to work with Chromedriver
  chrome:
    image: ghcr.io/erseco/alpine-chromedriver
    container_name: chrome
    hostname: chrome # Important! To be called from exelearning container
    shm_size: "2gb"
    # ports:
    #   - "9515:9515" # Whe don't really need to expose ports
    profiles:
      - e2e # Container only will be started with --profile e2e option
    volumes:
      - ./tests/Fixtures:/app/tests/Fixtures:cached # Mount the SAME Fixtures directory

volumes:
  mnt-data:

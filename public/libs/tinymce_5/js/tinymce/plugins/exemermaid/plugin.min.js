/**
 * plugin.min.js
 *
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Luis Ramón López López for http://exelearning.net/
 *
 * License: http://creativecommons.org/licenses/by-sa/4.0/
 */

/**
 * Insert mermaid code
 */
tinymce.PluginManager.add('exemermaid', function (editor, url) {

	let $ = tinymce.dom.DomQuery;

	function setHTMLAttribs() {
		// add id to textarea
		let divHtmlSource = $('div.tox-form__group').eq(1);
		let textareaHtmlSource = divHtmlSource.children().eq(0);
		tinymce.DOM.setAttrib(textareaHtmlSource, { 'id': 'htmlSource' });
	}

	PasteMermaidDialog = {
		actualHtmlSource: '',
		setDefaultData: function() {
			PasteMermaidDialog.actualHtmlSource = '';
		},
        getInitialData:function () {
            return {
                htmlSource: PasteMermaidDialog.actualHtmlSource
            };
        },
        activateButton: function (node) {
            return node.nodeName === "PRE" && node.className.indexOf("mermaid") !== -1;

        },
        getValues: function () {
            var sel = tinyMCE.activeEditor.selection;
            var v = sel.getContent({ format: 'text' });
            var node = sel.getNode();

            this.initialValue = v;
            this.isUpdating = false;

            if (node.nodeName === "PRE") {
                var c = node.innerHTML;
                c = c.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                v = c;
                this.isUpdating = true;
            }
            PasteMermaidDialog.actualHtmlSource = v;
        },
        // Create or update the content
        insert: function (content) {
            var editor = tinyMCE.activeEditor;

            // Code (the content)
            var t = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var c = "<pre class=\"mermaid\">" + t + "</pre>";
            if (content === "") c = "";

            // Insert the content
            if (this.isUpdating === false) {
                // New content
                editor.insertContent(c);
            } else {
                // Update the selected content
                var ed = editor;
                var node = ed.selection.getNode();
                ed.dom.setHTML(node, t);
            }
            // Close the editor
            editor.windowManager.close();
        },
		openHTMLDialog: function () {
            PasteMermaidDialog.getValues();
			// Open the window
			win = editor.windowManager.open({
				title: _('Paste Mermaid code (diagram)'),
				// width: 500,
				// height: 222,
				body:
				{
					type: 'panel',
					items: [
						{
							type: 'label',
							label: _('Use CTRL+V on your keyboard to paste into the window.'),
							items: []
							// forId: 'htmlSource'
						},
						{
							type: 'textarea',
							// id: 'htmlSource',
							name: 'htmlSource'
							// minHeight: 150,
							// value: ...(),
							// multiline: true
						}
					]
				},
				buttons: [
					{
						type: 'cancel',
						name: 'cancel',
						text: 'Cancel'
					},
					{
						type: 'submit',
						name: 'save',
						text: 'Save',
						primary: true
					}
				],
				initialData: PasteMermaidDialog.getInitialData(),
				onSubmit: function (api) {
                    PasteMermaidDialog.actualHtmlSource = api.getData().htmlSource;
                    PasteMermaidDialog.insert(PasteMermaidDialog.actualHtmlSource);
                    return false;
				},
				onClose: function () {
					PasteCodeDialog.setDefaultData();
				}
			});

			setHTMLAttribs();

			let divDialog = $('div.tox-dialog').eq(0);
			tinymce.DOM.setStyle(divDialog, 'height', 400);
		}

	} // PasteCodeDialog

	editor.ui.registry.addIcon('exemermaid', `
	<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <!-- M-shaped -->
        <path d="M4 16 L8 5 L12 12 L16 5 L20 16"
              fill="none"
              stroke="#000000"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"/>
    </svg>

	`);

    editor.ui.registry.addToggleButton('exemermaid', {
        image: url + '/img/exemermaid.png',
        icon: 'exemermaid',
        // text: 'code',
        tooltip: _('Paste Mermaid fragment (diagram)'),
        onAction: PasteMermaidDialog.openHTMLDialog,
        onSetup: function (buttonApi) {
            var editorEventCallback = function (eventApi) {
                buttonApi.setActive(PasteMermaidDialog.activateButton(eventApi.element));
            };
            editor.on('NodeChange', editorEventCallback);
            return function (buttonApi) {
                editor.off('NodeChange', editorEventCallback);
            }
        }
    });

	editor.ui.registry.addMenuItem('exemermaid', {
		// icon: 'image',
		icon: 'exemermaid',
		text: _('Paste Mermaid code (diagram)'),
		onAction: PasteMermaidDialog.openHTMLDialog,
		context: 'insert'
	});

    editor.on('init', function (e) {
        editor.dom.loadCSS(url + "/css/content.css");
    });

    editor.on('deactivate', function (e) {
        $exe.mermaid.init();
    });
});
